<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ぴちボード（Firebase Firestore 掲示板）</title>
  <style>
    :root{--bg:#0b1020;--fg:#e7eeff;--muted:#9fb0c8;--line:#2a3850;--card:#11182a;--accent:#69e0a3;--warn:#ffd166}
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 80% -10%,#12203b 0%,var(--bg) 60%);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Noto Sans JP,Arial}
    .wrap{max-width:920px;margin:0 auto;padding:24px 16px 60px}
    header{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{font-size:22px;margin:0 0 4px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--line);border-radius:14px;padding:14px 14px;box-shadow:0 8px 24px rgba(0,0,0,.3)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,textarea,button,select{border-radius:10px;border:1px solid var(--line);background:#0f1526;color:var(--fg);padding:10px 12px}
    textarea{width:100%;min-height:88px;resize:vertical}
    button{cursor:pointer}
    button.primary{background:var(--accent);color:#012;border:none;font-weight:700}
    button.ghost{background:transparent}
    .muted{color:var(--muted);font-size:12px}
    .posts{display:grid;gap:10px;margin-top:14px}
    .post{border:1px solid var(--line);border-radius:12px;padding:12px;background:var(--card)}
    .meta{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .meta .left{display:flex;gap:10px;align-items:center}
    .id{font-family:ui-monospace,Menlo,Consolas,monospace;color:#a8c7ff;font-size:12px}
    .time{color:var(--muted);font-size:12px}
    .text{white-space:pre-wrap;line-height:1.6;margin:6px 0 0}
    .controls{display:flex;gap:8px}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .pill{padding:6px 10px;border-radius:999px;background:#0f1526;border:1px solid var(--line);font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ぴちボード（匿名ログイン・リアルタイム）</h1>
        <div class="muted">初回アクセスで匿名ログイン。<b>誰でも削除可（駅ボード仕様）</b>／編集は本人のみ。</div>
      </div>
      <div class="pill" id="user-pill">UID: <span id="uid">(未ログイン)</span></div>
    </header>

    <section class="card" style="margin-top:12px">
      <div class="row">
        <label>ニックネーム
          <input id="nickname" placeholder="例：ぴち博士" />
        </label>
        <span class="muted">（端末に保存／省略可）</span>
      </div>
      <div class="divider"></div>
      <label>本文（2000字まで）</label>
      <textarea id="message" placeholder="いま考えていること…"></textarea>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div class="muted">保存：<code>boards</code> コレクション / <code>createdAt</code> 降順</div>
        <div class="row">
          <button id="postBtn" class="primary">投稿</button>
          <button id="clearBtn" class="ghost">クリア</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="row" style="justify-content:space-between">
        <div>投稿一覧</div>
        <div class="row">
          <select id="limitSelect">
            <option value="20">20件</option>
            <option value="50">50件</option>
            <option value="100">100件</option>
          </select>
          <button id="refreshBtn" class="ghost">更新</button>
        </div>
      </div>
      <div id="posts" class="posts" aria-live="polite"></div>
    </section>

    <p class="muted" style="margin-top:12px">
      ※ 下の <code>firebaseConfig</code> をあなたの値（コンソールに表示）に置き換えて保存してください。
    </p>
  </div>

  <!-- Firebase Web SDK を ES Modules で読込（CDN版） -->
  <script type="module">
    // ===== ▼ ここをあなたの config に置き換え ▼ =====
    const firebaseConfig = {
      apiKey: "AIzaSyAvuWLxPpLlx_zEp9Dz0HoQ9yj0AlWTQQo",
      authDomain: "pitihakasekennkyuusitu.firebaseapp.com",
      projectId: "pitihakasekennkyuusitu",
      storageBucket: "pitihakasekennkyuusitu.firebasestorage.app",
      messagingSenderId: "583878356027",
      appId: "1:583878356027:web:dad771f865165157f8001e"
    };
    // ===== ▲ 置き換えここまで ▲ =====

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, limit, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const uidEl = document.getElementById('uid');
    const nickEl = document.getElementById('nickname');
    const msgEl = document.getElementById('message');
    const postBtn = document.getElementById('postBtn');
    const clearBtn = document.getElementById('clearBtn');
    const postsEl = document.getElementById('posts');
    const limitSel = document.getElementById('limitSelect');
    const refreshBtn = document.getElementById('refreshBtn');

    // 匿名ログイン
    let currentUser = null;
    onAuthStateChanged(auth, async (user) => {
      if (!user) await signInAnonymously(auth);
      currentUser = user || auth.currentUser;
      if (currentUser) {
        uidEl.textContent = currentUser.uid;
        loadNickname();
        attachFeed();
      }
    });

    // ニックネーム保存
    function loadNickname(){
      const saved = localStorage.getItem('pichi_nick');
      if (saved) nickEl.value = saved;
      nickEl.addEventListener('input',()=> localStorage.setItem('pichi_nick', nickEl.value.trim()));
    }

    // 投稿
    postBtn.addEventListener('click', async ()=>{
      const text = msgEl.value.trim();
      if (!currentUser) return alert('ログイン待ち…');
      if (!text) return alert('本文が空です');
      if (text.length > 2000) return alert('文字数は2000まで');
      const nickname = (nickEl.value || '').trim().slice(0,32) || '名無し';
      postBtn.disabled = true;
      try{
        await addDoc(collection(db,'boards'),{
          text,
          nickname,
          uid: currentUser.uid,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        msgEl.value = '';
      }catch(e){
        console.error(e); alert('投稿に失敗: '+ e.message);
      }finally{
        postBtn.disabled = false;
      }
    });
    clearBtn.addEventListener('click',()=> msgEl.value='');

    // フィード購読
    let unsub = null;
    function attachFeed(){
      if (unsub) unsub();
      const lim = Number(limitSel.value || '20');
      const q = query(collection(db,'boards'), orderBy('createdAt','desc'), limit(lim));
      unsub = onSnapshot(q, snap => {
        postsEl.innerHTML = '';
        snap.forEach(docSnap => postsEl.appendChild(renderPost(docSnap.id, docSnap.data())));
      });
    }
    limitSel.addEventListener('change', attachFeed);
    refreshBtn.addEventListener('click', attachFeed);

    // 投稿DOM
    function renderPost(id, data){
      const el = document.createElement('article');
      el.className = 'post';
      const created = data.createdAt?.toDate?.() || new Date();
      el.innerHTML = `
        <div class="meta">
          <div class="left">
            <span class="id">#${id.slice(0,8)}</span>
            <strong>${escapeHtml(data.nickname || '名無し')}</strong>
          </div>
          <div class="time">${fmt(created)}</div>
        </div>
        <div class="text">${linkify(escapeHtml(data.text || ''))}</div>
        <div class="controls"></div>
      `;
      const ctl = el.querySelector('.controls');
      if (currentUser) {
        if (currentUser.uid === data.uid) {
          ctl.append(button('編集', ()=> startEdit(id, data)));
        }
        ctl.append(button('削除', ()=> delPost(id)));
      }
      return el;
    }

    function button(label, onClick){
      const b=document.createElement('button'); b.textContent=label; b.className='ghost'; b.addEventListener('click', onClick); return b;
    }

    async function startEdit(id, data){
      const newText = prompt('編集内容を入力', data.text || '');
      if (newText==null) return;
      if (!newText.trim()) return alert('本文が空です');
      try{ await updateDoc(doc(db,'boards',id),{ text:newText.trim(), updatedAt: serverTimestamp() }); }
      catch(e){ alert('更新失敗: '+e.message); }
    }

    async function delPost(id){
      if (!confirm('削除しますか？')) return;
      try{ await deleteDoc(doc(db,'boards',id)); }
      catch(e){ alert('削除失敗: '+e.message); }
    }

    // 小物
    function fmt(d){ const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch])); }
    function linkify(s){ const urlRE=/(https?:\/\/[^\s]+)/g; return s.replace(urlRE,'<a href="$1" target="_blank" rel="noopener">$1</a>'); }
  </script>

  <!-- Firestore セキュリティ 例（コンソールの ルール に貼る）
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /boards/{docId} {
        allow read: if true;
        allow create: if request.auth != null
                      && request.resource.data.text is string
                      && request.resource.data.text.size() > 0
                      && request.resource.data.text.size() <= 2000
                      && request.resource.data.uid == request.auth.uid
                      && request.resource.data.createdAt != null;
        allow update: if request.auth != null && request.auth.uid == resource.data.uid;
        allow delete: if request.auth != null;
      }
    }
  }
  -->
</body>
</html>
